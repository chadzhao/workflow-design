# 工作流设计

    基本思想

- 表单和流程节点使用Json字义
- 表单和流程节点使用版本，一旦有流程建立则固定使用该版本
- 工作流数据直接Json保存，MySql支持Json查询，数据量不大的时候性能影响很小
    - 工作流查询已按模板过滤一次，数据量大大减少
    - 后台OA系统，使用动态字段查询频率本来就不会高。
    - 用户能容忍查询稍微慢一点
    - 工作流数据量远达不到大量的程度（1万以上才算）
- 表单打印使用HTML
- 表单导出Excel与表单布局不一致，以方便导入

## 表单设计器
- 直接定义行数和列数，以及每行调试和每列宽度（模仿Excel）
- 整体尺寸以A4纸宽度为基准，转换成像素
- 字段名和填空都可设置跨行列数
- 使用Json序列化保存表单设计
- Json数据定义如下：

```javascript
var config = 
  {
    'cols' : [10,20,30,20,20], // 每列宽度定义（单位：像素，最后一列自动占满剩余空间）
    'rows' : [20,20,20,20,20,20], // 每行高度定义（单位：像素，最后一行占满剩余空间） 
    'maxFieldId' : 1, // 当前已分配的最大字段Id（防止重复使用）
    'fields' : [ 
        { // 字段
            'id' : 1, // 每个字段都有唯一的表单内id（使用内部自增即可）
            'row' : 0, // 行Index
            'col' : 0, // 列Index 
            'colSpan' : 1, // 所占列数
            'rowSpan' : 1, // 所占行数
            'name' : '项目名称', // 字段名称，一般用来显示在列表里或搜索名称里
            'label' : {
                'name' : '显示全称', // 在表单里的显示全称（比如有中英换行）
                'position' : 'Left', // 在字段定义的哪一侧：Left/Top/Right/Bottom
                'span' : 1, // 占用行数或列数
            }
            'type' : 'text', // 字段类型(text/number/select/file)
            'style' : { // 额外的样式（比如文字过多可以把字体设置小）
                'font-size' : '12px'
            }
        }
    ],
    'tables' : ['采购清单'], // 系统内置的数据列表，比如采购清单
    'maxFlowId' : 1, // 当前已分配的最大流程节点Id（防止重复使用）
    'flows' : [ // 工作流流程节点定义
        {
            'id' : 1, // 流程节点Id，内部自增（Id为1的永远是最初的起点）
            'name' : '建立表单', // 流程节点名称
            'accepterIds' : [1,3], // 可以受理本节点的人选（初始节点无需配置）
            'editableFields' : [1,2],  // 指定可编辑的字段
            'visibleFields' : [3,4], // 指定可见（不可编辑）的字段
            'approvedId' : 2, // 下一节点Id，-1表示完成
            'rejectedId' : 1, // 被拒后节点Id
        }
    ]
  }
```

#### 表单设计器渲染技巧 `VUE/Angular`

- 遍历所有元素，根据元素的属性计算出坐标和尺寸，定位显示出来
- 根据元素类型动态显示相应组件
- 当选中某元素时，标记当前已选元素 selectedField=e; 右侧的设计器双向绑定其属性直接编辑
- 新增元素时maxFieldId自动加1，删除时不回减（防止重复使用）
- 每行最开始提供选择整行功能，进而可以设置行高
- 每列最开始提供选择整列功能，进而可以设置列宽
- 提供A4纸尺寸参考，防止超出布局（打印优化）
- 以上方案也可用在生成Excel中

## 工作流设计

    简单起见，将流程固定为：先填写表单，然后提交。提交后即进入审核阶段，可以有多个审核过程，只要审核未通过，就打回原始状态（填写表单）。
    
    提交审核时可选是否在线下进行，选择后可打印出来在线下走流程。

    目前所有涉及到的列表均不在表单设计器中进行，只需要将涉及到的列表关联一下即可，然后直接在网页中固定展示，导出Excel时可使用标签页处理每个列表。比如采购流程中的物品清单，即为固定列表，只需要在采购流程模板配置时选上这个物品清单就行。

#### 工作流定义

- 创建工作流模板
- 在模板中定义表单及流转节点（除了第1个是表单节点，其他都是审批节点）
- 第1个节点可选进入线下审核或直接提交审核（线上进行）
- 每个节点功能：
  - 可选择表单所有字段的可见性（可编辑、可见、不可见）
  - 选择下一个节点（审批通过节点）
  - 未通过则进入表单节点

#### 流程设计器

    使用简单直接的设计，在页面固定位置显示流程图。节点之间可无需自由连接，比如开始节点下一个就是创建表单节点，是固定的。之后点击表单节点，在右侧属性里选择下一节点。默认所有非表单节点的审核未通过都指向表单节点（可以考虑允许修改）。

    这样设计器就会简化。

#### 工作流运行

- 选择工作流模板，创建一条工作流记录
- 工作流记录当前模板版本号，以后使用这个版本下的模板配置进行
- 创建者填写表单，提交，工作流记录修改节点Id及待办人信息
- 待办人审核通过，进入下一节点（修改节点Id和新待办人）
- 待办人审核未通过，则回到表单节点，待办人为创建人
- 最终审核通过时，工作流标记完成

#### 模板版本号

- 当模板修改会影响已有工作流时，会生成新的版本号。在这之后创建的工作流将使用新版本。
- 不会增加版本的操作：
  - 修改模板名称、表单显示调整、字段名称调整、增加字段、增加流程、修改流程负责人
- 会增加版本的操作：
  - 删除字段、删除流程

## 数据库表

#### 工作流模板表 `utWfTemplate`

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| Id | int | 自增 |
| Name | string | 工作流名称 |
| FormConfig | string | 表单Json数据 |
| Version | int | 当前版本 |
| Fields | string | 此模板拥有的所有动态字段：包括历史记录 |

```javascript
    // fields格式定义（同Id的Name取最新名称，标记最新版本是否还在使用）
    var json = [
        { id : 1, type : text, name : '字段名称', isInUse : true },
        { id : 2, type : int, name : '字段名称', isInUse : true },
        { id : 3, type : float, name : '字段名称', isInUse : false },
    ];
```

#### 表单版本表 `utWfFormVersion`
    只有修改流程、增删字段才会生成新版本，否则直接视为最新版（模板和当前版本一起更新）
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| Id | int | 自增 |
| WfTemplateId | int | 对应工作流模板Id |
| FormConfig | string | 表单Json数据 |

#### 工作流记录表 `utWfRecord`

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| Id | int | 自增 |
| WfTemplateId | int | 对应工作流模板Id |
| Version | int | 对应表单版本Id |
| AcceptorId | int | 当前负责人Id |
| FormData | string | Json形式保存所有Form值，格式见下方 |

```javascript
// FormData Json数据格式
var json = {
    's1' : '字符串使用s+字段Id形式',
    'i2' : '整形使用i+字段Id形式',
    'f3' : '浮点使用f+字段Id形式',
    'd4' : '时间使用d+字段Id形式',
};
```

#### 工作流节点表 `utWfItem`

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| Id | int | 自增 |
| FlowId | int | 流程节点内部Id |
| Name | string | 节点名称 |
| AcceptorId | int | 当前节点负责人Id |
| IsAccepted | bool? | 是否通过 |
| Remark | string | 通过或未通过的批注 |
| FinishTime | date? | 完成时间 |
| CreateTime | date | 创建时间 |

## 常规查询

#### 动态字段匹配查询
    比如查找模板为2，字段id=1，类型为string，关键字为keyword的记录.
```sql
    -- 先查询工作流记录
    select * from utWfRecord where wfTemplateId=2 and JSON_EXTRACT(FormData, '$.s1') like '%keyword%'

    -- 再根据Version加载表单定义，将FormData还原
```